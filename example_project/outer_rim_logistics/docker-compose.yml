x-security-defaults: &security-defaults
  security_opt:
    - no-new-privileges:true

services:
  web:
    build:
      context: ../../
      dockerfile: example_project/outer_rim_logistics/Dockerfile
    environment:
      DJANGO_DEBUG: "False"
      DJANGO_SECRET_KEY_FILE: "/run/secrets/django_secret_key"
      POSTGRES_HOST: db
      POSTGRES_PORT: "5432"
      POSTGRES_DB: "${POSTGRES_DB:-orl}"
      POSTGRES_USER: "${POSTGRES_USER:-orl}"
      POSTGRES_PASSWORD_FILE: "/run/secrets/postgres_password"
      MEILISEARCH_URL: "http://meilisearch:7700"
      MEILISEARCH_API_KEY_FILE: "/run/secrets/meilisearch_api_key"
      GM_SEARCH_AUTO_REINDEX: "false"
      GM_SEARCH_ASYNC: "true"
      STATIC_ROOT: "/static"
      LOG_DIR: "/var/log/outer-rim"
      ORL_SEED_ON_START: "${ORL_SEED_ON_START:-true}"
      CELERY_BROKER_URL: "redis://redis:6379/0"
      CELERY_RESULT_BACKEND: "redis://redis:6379/1"
      REDIS_URL: "redis://redis:6379/0"
      DJANGO_SECURE_SSL_REDIRECT: "true"
      DJANGO_SECURE_HSTS_SECONDS: "31536000"
      DJANGO_SECURE_HSTS_INCLUDE_SUBDOMAINS: "true"
      DJANGO_SECURE_HSTS_PRELOAD: "true"
      DJANGO_CSRF_TRUSTED_ORIGINS: "https://localhost:8443"
    volumes:
      - ./logs:/var/log/outer-rim
      - orl-static:/static
    depends_on:
      - db
      - meilisearch
      - prometheus
      - redis
    networks:
  backend:

secrets:
      - django_secret_key
      - meilisearch_api_key
      - postgres_password
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8000/metrics/', timeout=2)\"",
        ]
      interval: 30s
      timeout: 5s
      retries: 5

  nginx:
    security_opt:
      - no-new-privileges:true
    build:
      context: .
      dockerfile: docker/nginx.Dockerfile
    ports:
      - "8000:80"
      - "8443:443"
    volumes:
      - ./docker/nginx.conf:/etc/nginx/nginx.conf:ro
      - orl-static:/static:ro
      - ./docker/certs:/etc/nginx/certs:ro
      - ./logs:/var/log/outer-rim
    depends_on:
      - web
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost/ > /dev/null"]
      interval: 30s
      timeout: 5s
      retries: 5

  db:
    image: postgres:16-alpine
    command:
      [
        "postgres",
        "-c",
        "shared_preload_libraries=pg_stat_statements",
        "-c",
        "pg_stat_statements.max=10000",
        "-c",
        "pg_stat_statements.track=all",
      ]
    environment:
      POSTGRES_DB: "${POSTGRES_DB:-orl}"
      POSTGRES_USER: "${POSTGRES_USER:-orl}"
      POSTGRES_PASSWORD_FILE: "/run/secrets/postgres_password"
    ports:
      - "5432:5432"
    volumes:
      - orl-postgres:/var/lib/postgresql/data
    secrets:
      - postgres_password
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-orl}"]
      interval: 10s
      timeout: 5s
      retries: 5

  meilisearch:
    image: getmeili/meilisearch:v1.34.0
    environment:
      MEILI_MASTER_KEY: "${MEILISEARCH_API_KEY:-orl-master-key}"
      MEILI_NO_ANALYTICS: "true"
    ports:
      - "7700:7700"
    volumes:
      - orl-meili:/meili_data
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:7700/health > /dev/null"]
      interval: 30s
      timeout: 5s
      retries: 5

  prometheus:
    image: prom/prometheus:v2.52.0
    volumes:
      - ./docker/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9090:9090"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:9090/-/healthy > /dev/null"]
      interval: 30s
      timeout: 5s
      retries: 5
    networks:
      - backend

  pushgateway:
    <<: *security-defaults
    image: prom/pushgateway:v1.9.0
    read_only: true
    tmpfs:
      - /tmp
    networks:
      - backend

  postgres-exporter:
    <<: *security-defaults
    image: prometheuscommunity/postgres-exporter:v0.15.0
    entrypoint: ["/bin/sh", "/etc/postgres-exporter/entrypoint.sh"]
    environment:
      PG_EXPORTER_EXTEND_QUERY_PATH: "/etc/postgres-exporter/queries.yml"
    networks:
  backend:

secrets:
      - postgres_password
    volumes:
      - ./docker/postgres-exporter-entrypoint.sh:/etc/postgres-exporter/entrypoint.sh:ro
      - ./docker/postgres-exporter-queries.yml:/etc/postgres-exporter/queries.yml:ro
    depends_on:
      db:
        condition: service_healthy
    read_only: true
    tmpfs:
      - /tmp
    networks:
      - backend

  redis-exporter:
    <<: *security-defaults
    image: oliver006/redis_exporter:v1.63.0
    command: ["--redis.addr=redis://redis:6379"]
    depends_on:
      redis:
        condition: service_healthy
    read_only: true
    tmpfs:
      - /tmp
    networks:
      - backend

  celery-exporter:
    <<: *security-defaults
    image: ghcr.io/danihodovic/celery-exporter:latest
    command: ["--broker-url=redis://redis:6379/0", "--port=9808"]
    depends_on:
      redis:
        condition: service_healthy
    read_only: true
    tmpfs:
      - /tmp
    networks:
      - backend

  nginx-exporter:
    <<: *security-defaults
    image: nginx/nginx-prometheus-exporter:1.3.0
    command: ["-nginx.scrape-uri=http://nginx/nginx_status"]
    depends_on:
      nginx:
        condition: service_started
    read_only: true
    tmpfs:
      - /tmp
    networks:
      - backend

  grafana:
    image: grafana/grafana:11.0.0
    environment:
      GF_SECURITY_ADMIN_USER: "admin"
      GF_SECURITY_ADMIN_PASSWORD_FILE: "/run/secrets/grafana_admin_password"
      GF_USERS_ALLOW_SIGN_UP: "false"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./docker/grafana/provisioning:/etc/grafana/provisioning:ro
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
      - loki
    networks:
  backend:

secrets:
      - grafana_admin_password
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3000/api/health > /dev/null"]
      interval: 30s
      timeout: 5s
      retries: 5

  loki:
    image: grafana/loki:3.2.0
    command: -config.file=/etc/loki/config.yml
    volumes:
      - ./docker/loki.yml:/etc/loki/config.yml:ro
      - orl-loki:/loki
    ports:
      - "3100:3100"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3100/ready > /dev/null"]
      interval: 30s
      timeout: 5s
      retries: 5

  promtail:
    image: grafana/promtail:3.2.0
    command: -config.file=/etc/promtail/config.yml
    volumes:
      - ./docker/promtail.yml:/etc/promtail/config.yml:ro
      - ./logs:/var/log/outer-rim:ro
    depends_on:
      - loki

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - orl-redis:/data
    healthcheck:
      test: ["CMD-SHELL", "redis-cli ping | grep -q PONG"]
      interval: 10s
      timeout: 5s
      retries: 5

  celery-worker:
    build:
      context: ../../
      dockerfile: example_project/outer_rim_logistics/Dockerfile
    entrypoint: ""
    command: celery -A orl worker -l info
    environment:
      DJANGO_SECRET_KEY_FILE: "/run/secrets/django_secret_key"
      POSTGRES_HOST: db
      POSTGRES_PORT: "5432"
      POSTGRES_DB: "${POSTGRES_DB:-orl}"
      POSTGRES_USER: "${POSTGRES_USER:-orl}"
      POSTGRES_PASSWORD_FILE: "/run/secrets/postgres_password"
      MEILISEARCH_URL: "http://meilisearch:7700"
      MEILISEARCH_API_KEY_FILE: "/run/secrets/meilisearch_api_key"
      GM_SEARCH_AUTO_REINDEX: "false"
      GM_SEARCH_ASYNC: "true"
      LOG_DIR: "/var/log/outer-rim/app"
      CELERY_PUSHGATEWAY_URL: "http://pushgateway:9091"
      CELERY_PUSHGATEWAY_ENABLED: "true"
      CELERY_BROKER_URL: "redis://redis:6379/0"
      CELERY_RESULT_BACKEND: "redis://redis:6379/1"
      REDIS_URL: "redis://redis:6379/0"
    volumes:
      - ./logs:/var/log/outer-rim
    depends_on:
      - db
      - meilisearch
      - redis
    networks:
  backend:

secrets:
      - django_secret_key
      - meilisearch_api_key
      - postgres_password
    networks:
      - backend

  meili-init:
    image: alpine:3.19
    command: ["sh", "-c", "chown -R 1000:1000 /meili_data"]
    volumes:
      - orl-meili:/meili_data
    restart: "no"
    networks:
      - backend

  app-init:
    image: alpine:3.19
    command: ["sh", "-c", "mkdir -p /var/log/outer-rim/app && chown -R 1000:1000 /var/log/outer-rim/app /static"]
    volumes:
      - ./logs:/var/log/outer-rim
      - orl-static:/static
    restart: "no"
    networks:
      - backend

  grafana-init:
    image: alpine:3.19
    command: ["sh", "-c", "chown -R 472:472 /var/lib/grafana"]
    volumes:
      - grafana-data:/var/lib/grafana
    restart: "no"
    networks:
      - backend

  redis-init:
    image: alpine:3.19
    command: ["sh", "-c", "chown -R 999:999 /data"]
    volumes:
      - orl-redis:/data
    restart: "no"
    networks:
      - backend

  loki-init:
    image: alpine:3.19
    command: ["sh", "-c", "chown -R 10001:10001 /loki"]
    volumes:
      - orl-loki:/loki
    restart: "no"
    networks:
      - backend

  db-init:
    image: postgres:16-alpine
    user: "0:0"
    command: ["sh", "-c", "chown -R postgres:postgres /var/lib/postgresql/data"]
    volumes:
      - orl-postgres:/var/lib/postgresql/data
    restart: "no"
    networks:
      - backend

  db-extensions:
    image: postgres:16-alpine
    command:
      [
        "sh",
        "-c",
        "until pg_isready -h db -U ${POSTGRES_USER:-orl}; do sleep 1; done; PGPASSWORD=$$(cat /run/secrets/postgres_password) psql -h db -U ${POSTGRES_USER:-orl} -d ${POSTGRES_DB:-orl} -c \"CREATE EXTENSION IF NOT EXISTS pg_stat_statements;\"",
      ]
    networks:
  backend:

secrets:
      - postgres_password
    depends_on:
      db:
        condition: service_healthy
    restart: "no"
    networks:
      - backend

  db-backup:
    <<: *security-defaults
    image: postgres:16-alpine
    command:
      [
        "sh",
        "-c",
        "apk add --no-cache curl >/dev/null 2>&1; while true; do ts=$$(date +%s); file=/backups/orl_$$(date +%F_%H%M%S).sql; if PGPASSWORD=$$(cat /run/secrets/postgres_password) pg_dump -h db -U ${POSTGRES_USER:-orl} ${POSTGRES_DB:-orl} > \"$$file\"; then size=$$(wc -c < \"$$file\" | tr -d ' '); printf 'db_backup_last_success_timestamp_seconds %s\\ndb_backup_last_size_bytes %s\\n' \"$$ts\" \"$$size\" | curl -sS --data-binary @- http://pushgateway:9091/metrics/job/db_backup; else printf 'db_backup_last_failure_timestamp_seconds %s\\n' \"$$ts\" | curl -sS --data-binary @- http://pushgateway:9091/metrics/job/db_backup; fi; sleep 86400; done",
      ]
    volumes:
      - db-backups:/backups
    secrets:
      - postgres_password
    depends_on:
      db:
        condition: service_healthy
      pushgateway:
        condition: service_started
    read_only: true
    tmpfs:
      - /tmp
    networks:
      - backend

volumes:
  orl-postgres:
  orl-meili:
  grafana-data:
  orl-static:
  orl-loki:
  orl-redis:
  db-backups:

networks:
  backend:

secrets:
  django_secret_key:
    file: ./docker/secrets/django_secret_key.txt
  postgres_password:
    file: ./docker/secrets/postgres_password.txt
  meilisearch_api_key:
    file: ./docker/secrets/meilisearch_api_key.txt
  grafana_admin_password:
    file: ./docker/secrets/grafana_admin_password.txt
